{"ast":null,"code":"import { take, fork, call, put, takeLatest, select } from 'redux-saga/effects';\nimport { eventChannel } from 'redux-saga';\nimport { INITIATE_WS_CONNECTION, SEND_BY_WS, ADD_VIEWER, VIEWER_CONNECTED, VIEWER_DISCONNECTED, HOST_CONNECTED, HOST_DISCONNECTED, VIEWER_DISCONNECT } from './constants';\nimport getWebSocket from '../../utils/getWebSocket';\nimport { displayNotification } from '../Notifications/actions';\nimport { WSConnected, viewerConnected, viewerDisconnected, hostConnected, hostDisconnected } from './actions';\nimport * as streamsApi from '../../api/streams';\nimport { Auth_NicknameSelector } from '../Auth/selectors';\nimport { UpdateViewerCount } from '../StreamView/actions';\nexport default function* rootSaga() {\n  yield fork(flow);\n  yield fork(connectionsHandlers);\n}\nexport function* connectionsHandlers() {\n  yield takeLatest(VIEWER_CONNECTED, handleViewerConnection);\n  yield takeLatest(VIEWER_DISCONNECTED, handleViewerDisconnection);\n  yield takeLatest(HOST_CONNECTED, handleHostConnection);\n  yield takeLatest(HOST_DISCONNECTED, handleHostDisconnection);\n}\nexport function* flow() {\n  yield take(INITIATE_WS_CONNECTION);\n  const socket = yield call(connect);\n  yield put(WSConnected(socket.id));\n  yield fork(read, socket);\n  yield fork(write, socket);\n  const action = yield take(VIEWER_DISCONNECT);\n  yield call(disconnect, socket, action);\n}\n\nfunction connect() {\n  const socket = getWebSocket();\n  return new Promise(resolve => {\n    socket.on('connect', () => {\n      resolve(socket);\n    });\n  });\n}\n\nfunction* disconnect(socket, action) {\n  console.log(action);\n  socket.emit('viewerDisconnect', action.payload);\n}\n\nfunction* read(socket) {\n  const channel = yield call(subscribe, socket);\n\n  while (true) {\n    let action = yield take(channel);\n    yield put(action);\n  }\n}\n\nexport function subscribe(socket) {\n  return new eventChannel(emit => {\n    const handleViewerConnectionWS = data => {\n      return emit(viewerConnected(data));\n    };\n\n    const handleHostConnectionWS = data => {\n      return emit(hostConnected(data));\n    };\n\n    const handleHostDisconnectionWS = data => {\n      return emit(hostDisconnected(data));\n    };\n\n    const handleViewerDisconnectionWS = data => {\n      return emit(viewerDisconnected(data));\n    };\n\n    socket.on('viewerConnected', handleViewerConnectionWS);\n    socket.on('viewerDisconnected', handleViewerDisconnectionWS);\n    socket.on('hostConnected', handleHostConnectionWS);\n    socket.on('hostDisconnected', handleHostDisconnectionWS);\n    return () => {};\n  });\n}\nexport function* write(socket) {\n  while (true) {\n    const {\n      data\n    } = yield take(SEND_BY_WS);\n    socket.emit(data.type, data.info);\n  }\n}\nexport function* addViewerSaga() {\n  yield takeLatest(ADD_VIEWER, addViewer);\n}\nexport function* addViewer(action) {\n  try {\n    yield streamsApi.addViewer(action.payload);\n  } catch (error) {\n    console.error(error);\n  }\n}\nexport function* handleViewerConnection(action) {\n  const {\n    nickname,\n    message,\n    name\n  } = action.payload;\n  const channelNickname = yield select(Auth_NicknameSelector);\n\n  if (nickname === channelNickname) {\n    yield put(displayNotification({\n      message: message\n    }));\n  }\n\n  yield put(UpdateViewerCount({\n    name: name,\n    connection: true\n  }));\n}\nexport function* handleHostConnection() {\n  yield put(displayNotification({\n    message: 'Host connected'\n  }));\n}\nexport function* handleHostDisconnection() {\n  yield put(displayNotification({\n    message: 'Host disconnected.'\n  }));\n}\nexport function* handleViewerDisconnection(action) {\n  const {\n    nickname,\n    message,\n    name\n  } = action.payload;\n  yield put(displayNotification({\n    message: `${name} has disconnected.`\n  }));\n  yield put(UpdateViewerCount({\n    name: name,\n    connection: false\n  }));\n}","map":{"version":3,"sources":["C:/Users/MircoFiocchi/Desktop/BroadcastApp/client/src/containers/App/saga.js"],"names":["take","fork","call","put","takeLatest","select","eventChannel","INITIATE_WS_CONNECTION","SEND_BY_WS","ADD_VIEWER","VIEWER_CONNECTED","VIEWER_DISCONNECTED","HOST_CONNECTED","HOST_DISCONNECTED","VIEWER_DISCONNECT","getWebSocket","displayNotification","WSConnected","viewerConnected","viewerDisconnected","hostConnected","hostDisconnected","streamsApi","Auth_NicknameSelector","UpdateViewerCount","rootSaga","flow","connectionsHandlers","handleViewerConnection","handleViewerDisconnection","handleHostConnection","handleHostDisconnection","socket","connect","id","read","write","action","disconnect","Promise","resolve","on","console","log","emit","payload","channel","subscribe","handleViewerConnectionWS","data","handleHostConnectionWS","handleHostDisconnectionWS","handleViewerDisconnectionWS","type","info","addViewerSaga","addViewer","error","nickname","message","name","channelNickname","connection"],"mappings":"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","sourcesContent":["import { take, fork, call, put, takeLatest, select } from 'redux-saga/effects';\r\nimport { eventChannel } from 'redux-saga';\r\nimport {\r\n  INITIATE_WS_CONNECTION,\r\n  SEND_BY_WS,\r\n  ADD_VIEWER,\r\n  VIEWER_CONNECTED,\r\n  VIEWER_DISCONNECTED,\r\n  HOST_CONNECTED,\r\n  HOST_DISCONNECTED,\r\n  VIEWER_DISCONNECT\r\n} from './constants';\r\nimport getWebSocket from '../../utils/getWebSocket';\r\nimport { displayNotification } from '../Notifications/actions';\r\nimport {\r\n  WSConnected,\r\n  viewerConnected,\r\n  viewerDisconnected,\r\n  hostConnected,\r\n  hostDisconnected,\r\n} from './actions';\r\nimport * as streamsApi from '../../api/streams';\r\nimport { Auth_NicknameSelector } from '../Auth/selectors';\r\nimport { UpdateViewerCount } from '../StreamView/actions';\r\n\r\nexport default function* rootSaga() {\r\n  yield fork(flow);\r\n  yield fork(connectionsHandlers);\r\n}\r\n\r\nexport function* connectionsHandlers() {\r\n  yield takeLatest(VIEWER_CONNECTED, handleViewerConnection);\r\n  yield takeLatest(VIEWER_DISCONNECTED, handleViewerDisconnection);\r\n  yield takeLatest(HOST_CONNECTED, handleHostConnection);\r\n  yield takeLatest(HOST_DISCONNECTED, handleHostDisconnection);\r\n}\r\n\r\nexport function* flow() {\r\n  yield take(INITIATE_WS_CONNECTION);\r\n  const socket = yield call(connect);\r\n  yield put(WSConnected(socket.id));\r\n  yield fork(read, socket);\r\n  yield fork(write, socket);\r\n  const action = yield take(VIEWER_DISCONNECT);\r\n  yield call(disconnect, socket, action);\r\n}\r\n\r\nfunction connect() {\r\n  const socket = getWebSocket();\r\n  return new Promise((resolve) => {\r\n    socket.on('connect', () => {\r\n      resolve(socket);\r\n    });\r\n  });\r\n}\r\n\r\nfunction* disconnect(socket, action) {\r\n  console.log(action);\r\n  socket.emit('viewerDisconnect', action.payload);\r\n}\r\n\r\nfunction* read(socket) {\r\n  const channel = yield call(subscribe, socket);\r\n  while (true) {\r\n    let action = yield take(channel);\r\n    yield put(action);\r\n  }\r\n}\r\n\r\nexport function subscribe(socket) {\r\n  return new eventChannel((emit) => {\r\n    const handleViewerConnectionWS = (data) => {\r\n      return emit(viewerConnected(data));\r\n    };\r\n\r\n    const handleHostConnectionWS = (data) => {\r\n      return emit(hostConnected(data));\r\n    };\r\n\r\n    const handleHostDisconnectionWS = (data) => {\r\n      return emit(hostDisconnected(data));\r\n    };\r\n\r\n    const handleViewerDisconnectionWS = (data) => {\r\n      return emit(viewerDisconnected(data));\r\n    };\r\n\r\n    socket.on('viewerConnected', handleViewerConnectionWS);\r\n    socket.on('viewerDisconnected', handleViewerDisconnectionWS);\r\n    socket.on('hostConnected', handleHostConnectionWS);\r\n    socket.on('hostDisconnected', handleHostDisconnectionWS);\r\n    return () => {};\r\n  });\r\n}\r\n\r\nexport function* write(socket) {\r\n  while (true) {\r\n    const { data } = yield take(SEND_BY_WS);\r\n    socket.emit(data.type, data.info);\r\n  }\r\n}\r\n\r\nexport function* addViewerSaga() {\r\n  yield takeLatest(ADD_VIEWER, addViewer);\r\n}\r\n\r\nexport function* addViewer(action) {\r\n  try {\r\n    yield streamsApi.addViewer(action.payload);\r\n  } catch (error) {\r\n    console.error(error);\r\n  }\r\n}\r\n\r\nexport function* handleViewerConnection(action) {\r\n  const { nickname, message, name } = action.payload;\r\n  const channelNickname = yield select(Auth_NicknameSelector);\r\n  if (nickname === channelNickname) {\r\n    yield put(displayNotification({ message: message }));\r\n  }\r\n\r\n  yield put(UpdateViewerCount({ name: name, connection: true}));\r\n}\r\n\r\nexport function* handleHostConnection() {\r\n  yield put(displayNotification({ message: 'Host connected' }));\r\n}\r\n\r\nexport function* handleHostDisconnection() {\r\n  yield put(displayNotification({ message: 'Host disconnected.' }));\r\n}\r\n\r\nexport function* handleViewerDisconnection(action) {\r\n  const { nickname, message, name } = action.payload;\r\n  yield put(displayNotification({ message: `${name} has disconnected.` }));\r\n  yield put(UpdateViewerCount({name: name, connection: false}));\r\n}\r\n"]},"metadata":{},"sourceType":"module"}